<!DOCTYPE html>
<html>

<head>
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 16px;
      font-size: 12px;
      color: #1E1E1E;
    }

    .section {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #E5E5E5;
    }

    .section:last-child {
      border-bottom: none;
    }

    .row {
      display: flex;
    }

    h3 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-size: 11px;
      font-weight: 500;
    }

    input[type="number"],
    textarea {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #D1D5DB;
      border-radius: 4px;
      font-size: 11px;
      box-sizing: border-box;
    }

    button {
      background: #18A0FB;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      margin-right: 8px;
      margin-bottom: 8px;
    }

    button:hover {
      background: #0C8CE9;
    }

    button:disabled {
      background: #9CA3AF;
      cursor: not-allowed;
    }

    button.secondary {
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
    }

    button.secondary:hover {
      background: #E5E7EB;
    }


    .results-container {
      display: none;
      margin-top: 16px;
    }

    .result-item {
      padding: 8px;
      border: 1px solid #E5E7EB;
      border-radius: 4px;
      margin-bottom: 4px;
      font-size: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .result-item:hover {
      background: #F9FAFB;
      border-color: #D1D5DB;
    }

    .result-item.selected {
      background: #EBF8FF;
      border-color: #18A0FB;
    }

    .result-item.has-issues {
      border-color: #F59E0B;
      background: #FFFBEB;
    }

    .result-item.no-issues {
      border-color: #10B981;
      background: #F0FDF4;
    }

    .result-node-name {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .result-changes {
      color: #6B7280;
    }

    .checkbox-group {
      margin: 8px 0;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin-right: 6px;
    }

    .error-message {
      color: #DC2626;
      font-size: 10px;
      margin-top: 4px;
    }

    .warning-message {
      color: #D97706;
      font-size: 10px;
      margin-top: 4px;
    }

    .info-message {
      color: #2563EB;
      font-size: 10px;
      margin-top: 4px;
    }

    /* Tab styles */
    .tab-container {
      margin-bottom: 16px;
    }

    .tab-buttons {
      display: flex;
      border-bottom: 1px solid #E5E5E5;
      margin-bottom: 16px;
    }

    .tab-button {
      flex: 1;
      padding: 8px 16px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      color: #6B7280;
      margin-right: 0;
      margin-bottom: 0;
    }

    .tab-button.active {
      color: #18A0FB;
      border-bottom-color: #18A0FB;
    }

    .tab-button:hover {
      background: #F9FAFB;
      color: #374151;
    }

    .tab-button.active:hover {
      color: #18A0FB;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    #results-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    #results-controls button {
      font-size: 10px;
      padding: 4px 8px;
    }
  </style>
</head>

<body>
  <!-- Tab Navigation -->
  <div class="tab-container">
    <div class="tab-buttons">
      <button class="tab-button active" id="tab-operations">操作</button>
      <button class="tab-button" id="tab-settings">設定</button>
    </div>

    <!-- Operations Panel -->
    <div class="tab-panel active" id="panel-operations">
      <!-- Actions Section -->
      <div class="section">
        <h3>スキャン or 選択に適用</h3>
        <div id="scan-mode-info" class="info-message">スキャンモード: ページ全体</div>
        <div class="row">
          <div>
            <button id="scan">スキャン実行</button>
          </div>
          <div>
            <button id="apply-selected">選択中のノードに適用</button>
          </div>
        </div>
        <h4>適用内容</h4>
        <div class="checkbox-group">
          <label><input type="checkbox" id="manual-remove-breaks" checked> 改行除去</label>
          <label><input type="checkbox" id="manual-convert-soft-breaks" checked> ソフト改行は改行に変換</label>
        </div>
      </div>

      <!-- Results Section -->
      <div class="results-container" id="results-container">
        <h3>検出結果</h3>
        <div id="results-summary"></div>
        <div id="results-controls">
          <button id="select-all" class="secondary">すべて選択</button>
          <button id="select-none" class="secondary">選択解除</button>
        </div>
        <div id="results-list"></div>
      </div>
    </div>

    <!-- Settings Panel -->
    <div class="tab-panel" id="panel-settings">
      <!-- Detection Configuration Section -->
      <div class="section">
        <h3>検出設定</h3>

        <label for="min-chars">スキャン対象の最小文字数:</label>
        <input type="number" id="min-chars" value="20" min="1" max="1000" />

        <label for="line-break-threshold">改行処理閾値 (コンテナ幅比率):</label>
        <input type="number" id="line-break-threshold" value="0.8" min="0.1" max="1.0" step="0.1" />

        <label for="font-width-multiplier">改行処理計算用フォント幅係数:</label>
        <input type="number" id="font-width-multiplier" value="1.0" min="0.5" max="1.5" step="0.05" />

        <label for="soft-break-chars">ソフト改行文字 (1行1文字):</label>
        <textarea id="soft-break-chars" rows="3" placeholder="改行文字を1行に1つずつ入力"> </textarea>

        <div class="checkbox-group">
          <label><input type="checkbox" id="detect-edge-breaking" checked> 右端改行検出</label>
          <label><input type="checkbox" id="detect-soft-break" checked> ソフト改行検出</label>
        </div>
      </div>
    </div>
  </div>

  <script>
    // State management
    let currentResults = [];
    let isProcessing = false;
    let selectedNodeIds = new Set();

    // Tab management
    function switchTab(tabName) {
      // Remove active classes
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));

      // Add active classes
      document.getElementById(`tab-${tabName}`).classList.add('active');
      document.getElementById(`panel-${tabName}`).classList.add('active');
    }

    // Configuration management
    function getConfig() {
      const softBreakText = document.getElementById('soft-break-chars').value;

      // ソフト改行文字の特別処理
      let softBreakChars = [];

      // テキストエリアの値を文字単位で処理
      for (let i = 0; i < softBreakText.length; i++) {
        const char = softBreakText[i];
        const code = char.charCodeAt(0);

        // ソフト改行文字（LSEP, PSEP）や特殊文字を検出
        if (code === 8232 || code === 8233 || code === 8203 || code === 65279) {
          if (softBreakChars.indexOf(char) === -1) {
            softBreakChars.push(char);
          }
        }
      }

      // 通常の改行で分割して追加の文字を処理
      const lines = softBreakText.split(/[\r\n]+/)
        .map(line => line.trim())
        .filter(line => line.length > 0);

      for (const line of lines) {
        // 通常の文字列として入力された場合
        if (line.length > 0 && softBreakChars.indexOf(line) === -1) {
          softBreakChars.push(line);
        }
      }

      // デフォルトのソフト改行文字を設定（空の場合）
      if (softBreakChars.length === 0) {
        softBreakChars = ['\u2028'];
      }

      return {
        minCharacters: parseInt(document.getElementById('min-chars').value),
        lineBreakThreshold: parseFloat(document.getElementById('line-break-threshold').value),
        fontWidthMultiplier: parseFloat(document.getElementById('font-width-multiplier').value),
        softBreakChars: softBreakChars,
        excludePatterns: [],
        enabledDetections: [
          'auto-width', // 常に有効
          document.getElementById('detect-edge-breaking').checked ? 'edge-breaking' : null,
          document.getElementById('detect-soft-break').checked ? 'soft-break' : null
        ].filter(Boolean)
      };
    }

    // UI State management
    function setProcessingState(processing) {
      isProcessing = processing;
      document.getElementById('scan').disabled = processing;
      document.getElementById('apply-selected').disabled = processing;

      // 選択関連ボタンの状態
      const selectAllBtn = document.getElementById('select-all');
      const selectNoneBtn = document.getElementById('select-none');
      // 問題のあるノードがある場合のみ「すべて選択」を有効にする
      const withIssues = currentResults.filter(r => r.issues.length > 0);
      if (selectAllBtn) selectAllBtn.disabled = processing || withIssues.length === 0;
      if (selectNoneBtn) selectNoneBtn.disabled = processing;
    }


    function showResults(results, scanInfo) {
      currentResults = results;
      selectedNodeIds.clear();

      const container = document.getElementById('results-container');
      const summary = document.getElementById('results-summary');
      const list = document.getElementById('results-list');

      const withIssues = results.filter(r => r.issues.length > 0);
      const scanInfoText = scanInfo ? ` (${scanInfo})` : '';
      summary.innerHTML = `
        <div class="info-message">
          ${withIssues.length}ノード検出${scanInfoText}
        </div>
      `;

      list.innerHTML = '';
      withIssues.forEach(result => {
        const item = document.createElement('div');
        item.className = 'result-item has-issues';
        item.dataset.nodeId = result.node.id;
        // テキスト内容を安全にHTMLエスケープ
        const textPreview = (result.originalText || '').substring(0, 50) +
          (result.originalText.length > 50 ? '...' : '');
        const escapedText = textPreview
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;');

        item.innerHTML = `
          <input type="checkbox" class="node-checkbox" data-node-id="${result.node.id}">
          <div class="result-content">
            <div class="result-node-name">${escapedText || result.node.name || 'Unnamed'}</div>
            <div class="result-changes">${result.estimatedChanges}</div>
          </div>
        `;

        // クリックイベントを追加
        item.addEventListener('click', (e) => {
          if (e.target.type !== 'checkbox') {
            const checkbox = item.querySelector('.node-checkbox');
            checkbox.checked = !checkbox.checked;
            checkbox.dispatchEvent(new Event('change'));
          }
        });

        // チェックボックスのchangeイベント
        const checkbox = item.querySelector('.node-checkbox');
        checkbox.addEventListener('change', (e) => {
          const nodeId = e.target.dataset.nodeId;
          if (e.target.checked) {
            selectedNodeIds.add(nodeId);
            item.classList.add('selected');
          } else {
            selectedNodeIds.delete(nodeId);
            item.classList.remove('selected');
          }
          updateSelectionAndFocus();
        });

        list.appendChild(item);
      });

      // 選択関連ボタンの状態を更新
      const selectAllBtn = document.getElementById('select-all');
      const selectNoneBtn = document.getElementById('select-none');
      if (selectAllBtn) selectAllBtn.disabled = withIssues.length === 0;
      if (selectNoneBtn) selectNoneBtn.disabled = false;

      container.style.display = 'block';
    }

    function showError(message) {
      const container = document.getElementById('results-container');
      const summary = document.getElementById('results-summary');

      summary.innerHTML = `<div class="error-message">エラー: ${message}</div>`;
      container.style.display = 'block';
    }

    function showWarning(message) {
      const container = document.getElementById('results-container');
      const summary = document.getElementById('results-summary');

      summary.innerHTML = `<div class="warning-message">警告: ${message}</div>`;
      container.style.display = 'block';
    }

    // 選択とフォーカス機能
    function updateSelectionAndFocus() {
      const selectedNodes = currentResults.filter(r => selectedNodeIds.has(r.node.id));

      // Figmaでノードを選択（空の場合も含む）
      parent.postMessage({
        pluginMessage: {
          type: 'select-nodes',
          nodeIds: Array.from(selectedNodeIds)
        }
      }, '*');
    }

    // Figmaの選択変更をUIに反映
    function syncSelectionFromFigma() {
      parent.postMessage({
        pluginMessage: {
          type: 'get-current-selection'
        }
      }, '*');
    }

    // すべて選択/解除機能
    function selectAllNodes() {
      const checkboxes = document.querySelectorAll('.node-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = true;
        checkbox.dispatchEvent(new Event('change'));
      });
    }

    function selectNoneNodes() {
      // 直接selectedNodeIdsをクリアしてUI更新
      selectedNodeIds.clear();

      // すべてのチェックボックスとUIを更新（changeイベントを発火させない）
      document.querySelectorAll('.result-item').forEach(item => {
        item.classList.remove('selected');
        const checkbox = item.querySelector('.node-checkbox');
        if (checkbox) {
          checkbox.checked = false;
        }
      });

      // Figmaの選択をクリア
      updateSelectionAndFocus();
    }

    // Event listeners
    document.getElementById('scan').onclick = () => {
      const config = getConfig();
      console.log('UI送信設定:', config);
      setProcessingState(true);

      // スキャン範囲の情報を表示
      const container = document.getElementById('results-container');
      const summary = document.getElementById('results-summary');
      summary.innerHTML = '<div class="info-message">スキャン中...</div>';
      container.style.display = 'block';

      parent.postMessage({
        pluginMessage: {
          type: 'scan',
          config: config
        }
      }, '*');
    };

    // 選択ボタンのイベントリスナー
    document.getElementById('select-all').onclick = selectAllNodes;
    document.getElementById('select-none').onclick = selectNoneNodes;

    document.getElementById('apply-selected').onclick = () => {
      const config = getConfig();
      const manualOptions = {
        removeLineBreaks: document.getElementById('manual-remove-breaks').checked,
        convertSoftBreaks: document.getElementById('manual-convert-soft-breaks').checked
      };

      parent.postMessage({
        pluginMessage: {
          type: 'apply-selected',
          config: config,
          options: manualOptions
        }
      }, '*');
    };


    // Tab event listeners
    document.getElementById('tab-operations').onclick = () => switchTab('operations');
    document.getElementById('tab-settings').onclick = () => switchTab('settings');

    // Message handling from plugin
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      switch (msg.type) {
        case 'scan-complete':
          setProcessingState(false);
          showResults(msg.results, msg.scanInfo);
          break;

        case 'error':
          setProcessingState(false);
          showError(msg.message);
          break;

        case 'warning':
          showWarning(msg.message);
          break;

        case 'selection-changed':
          updateUISelection(msg.selectedNodeIds);
          break;

        case 'config-loaded':
          applyConfigToUI(msg.config);
          break;

        case 'scan-mode-info':
          updateScanModeDisplay(msg.mode, msg.details);
          break;
      }
    };

    // 設定をUIに反映
    function applyConfigToUI(config) {
      document.getElementById('min-chars').value = config.minCharacters || 20;
      document.getElementById('line-break-threshold').value = config.lineBreakThreshold || 0.8;
      document.getElementById('font-width-multiplier').value = config.fontWidthMultiplier || 1.0;

      const softBreakChars = config.softBreakChars || ['\u2028'];
      // ソフト改行文字を適切に表示（改行で区切らない）
      document.getElementById('soft-break-chars').value = softBreakChars.join('');

      const enabledDetections = config.enabledDetections || ['auto-width', 'edge-breaking', 'soft-break'];
      document.getElementById('detect-edge-breaking').checked = enabledDetections.includes('edge-breaking');
      document.getElementById('detect-soft-break').checked = enabledDetections.includes('soft-break');
    }

    // 初期設定を適用
    function initializeUI() {
      // デフォルトのソフト改行文字を設定
      if (!document.getElementById('soft-break-chars').value.trim()) {
        document.getElementById('soft-break-chars').value = '\u2028';
      }
    }

    // UIの選択状態を更新
    function updateUISelection(figmaSelectedNodeIds) {
      // 現在のUI選択をクリア
      selectedNodeIds.clear();
      document.querySelectorAll('.result-item').forEach(item => {
        item.classList.remove('selected');
        const checkbox = item.querySelector('.node-checkbox');
        if (checkbox) {
          checkbox.checked = false;
        }
      });

      // Figmaで選択されているノードがUI結果リストに含まれていればチェック
      figmaSelectedNodeIds.forEach(nodeId => {
        const resultItem = document.querySelector(`[data-node-id="${nodeId}"]`);
        if (resultItem) {
          selectedNodeIds.add(nodeId);
          resultItem.classList.add('selected');
          const checkbox = resultItem.querySelector('.node-checkbox');
          if (checkbox) {
            checkbox.checked = true;
          }
        }
      });
    }


    // スキャンモード表示を更新
    function updateScanModeInfo() {
      parent.postMessage({
        pluginMessage: {
          type: 'get-scan-mode'
        }
      }, '*');
    }

    // スキャンモード表示を更新
    function updateScanModeDisplay(mode, details) {
      const scanModeInfo = document.getElementById('scan-mode-info');
      if (scanModeInfo) {
        scanModeInfo.innerHTML = `スキャンモード: ${mode}${details ? ` (${details})` : ''}`;
      }
    }

    // Initialize
    setProcessingState(false);
    initializeUI();
    updateScanModeInfo();

    // Load saved configuration on startup
    parent.postMessage({
      pluginMessage: {
        type: 'load-config'
      }
    }, '*');

    // パフォーマンス最適化：イベントベースの更新
    let scanModeUpdateInterval = null;
    let isUIVisible = true;

    // UIがアクティブな時のみ更新
    function startScanModeUpdates() {
      if (scanModeUpdateInterval) return;

      // 長い間隔でポーリング（フォールバック用）
      scanModeUpdateInterval = setInterval(() => {
        if (isUIVisible) {
          updateScanModeInfo();
        }
      }, 10000);
    }

    function stopScanModeUpdates() {
      if (scanModeUpdateInterval) {
        clearInterval(scanModeUpdateInterval);
        scanModeUpdateInterval = null;
      }
    }

    // ウィンドウのフォーカス状態を監視
    window.addEventListener('focus', () => {
      isUIVisible = true;
      updateScanModeInfo(); // 即座に更新
      // startScanModeUpdates();
    });

    window.addEventListener('blur', () => {
      isUIVisible = false;
      stopScanModeUpdates();
    });

    // ユーザーがUIを操作した時に更新
    document.addEventListener('click', () => {
      updateScanModeInfo();
    });

    // 初回開始
    // startScanModeUpdates();
  </script>
</body>

</html>